{% extends "base.html" %}

{% block title %}Dashboard - Legal Worklist{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>Today</h1>

    {# Macro for rendering a project card with inline follow-ups #}
    {% macro project_card(project) %}
    <li class="project-card {% if project.staleness_level != 'ok' %}staleness-{{ project.staleness_level }}{% endif %}">
        <div class="project-header">
            <div class="project-info">
                <div class="client-name">{{ project.client_name }}</div>
                <div class="project-name-row">
                    <span class="project-name">{{ project.project_name }}</span>
                    {% if project.staleness_level != 'ok' %}
                    <span class="staleness-badge staleness-{{ project.staleness_level }}">
                        {{ project.days_since_update }}d stale
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="project-deadline">
                {% if project.effective_deadline %}
                <span class="deadline deadline-{{ project.deadline_type }}">
                    {{ project.effective_deadline.strftime('%b %d') }}
                    {% if project.deadline_type == 'hard' %}(hard){% endif %}
                </span>
                {% endif %}
            </div>
        </div>

        {# Latest status preview #}
        {% set preview = project.get_status_preview(3) %}
        {% if preview %}
        <div class="status-preview">
            <p class="preview-text">{{ preview.text }}</p>
            {% if preview.has_more %}
            <button type="button" class="btn-expand" data-full-text="{{ preview.full_text | e }}">
                Show more...
            </button>
            {% endif %}
        </div>
        {% endif %}

        {# Inline follow-ups #}
        {% set pending_followups = project.get_pending_followups() %}
        {% if pending_followups %}
        <div class="inline-followups">
            <span class="followups-label">Follow-ups:</span>
            <ul class="followup-inline-list">
                {% for followup in pending_followups %}
                <li class="followup-inline {% if followup.due_date < today %}followup-overdue{% elif followup.due_date == today %}followup-due-today{% endif %}">
                    <span class="followup-target">{{ followup.target_name }}</span>
                    <span class="followup-due">({{ followup.due_date.strftime('%b %d') }})</span>
                    <form action="{{ url_for('followups.complete', id=followup.id) }}" method="post" class="inline-form" data-confirm="Mark this follow-up as complete?">
                        <button type="submit" class="btn btn-small btn-success">Done</button>
                    </form>
                    <form action="{{ url_for('followups.snooze', id=followup.id) }}" method="post" class="inline-form">
                        <input type="number" name="days" value="1" min="1" max="365" class="snooze-input">
                        <button type="submit" class="btn btn-small">Snooze</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="project-actions">
            <a href="{{ url_for('updates.new') }}?project_id={{ project.id }}" class="btn btn-small btn-primary">Add Update</a>
            <a href="{{ url_for('projects.detail', id=project.id) }}" class="btn btn-small">View</a>
        </div>
    </li>
    {% endmacro %}

    {# Due Today Section #}
    <section class="dashboard-section urgency-critical">
        <h2>Due Today</h2>
        {% if due_today %}
        <ul class="dashboard-list project-list">
            {% for project in due_today %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="placeholder">No projects due today.</p>
        {% endif %}
    </section>

    {# Due Tomorrow Section #}
    <section class="dashboard-section urgency-warning">
        <h2>Due Tomorrow</h2>
        {% if due_tomorrow %}
        <ul class="dashboard-list project-list">
            {% for project in due_tomorrow %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="placeholder">No projects due tomorrow.</p>
        {% endif %}
    </section>

    {# Due Next 5 Days Section #}
    <section class="dashboard-section urgency-info">
        <h2>Due in 2-5 Days</h2>
        {% if due_next_5_days %}
        <ul class="dashboard-list project-list">
            {% for project in due_next_5_days %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="placeholder">No projects due in 2-5 days.</p>
        {% endif %}
    </section>

    {# Due Next 2 Weeks Section #}
    <section class="dashboard-section">
        <h2>Due in 6-14 Days</h2>
        {% if due_next_2_weeks %}
        <ul class="dashboard-list project-list">
            {% for project in due_next_2_weeks %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="placeholder">No projects due in 6-14 days.</p>
        {% endif %}
    </section>
</div>
{% endblock %}
