{% extends "base.html" %}

{% block title %}Dashboard - Legal Worklist{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>Today</h1>

    {# Macro for rendering a project card with inline tasks #}
    {% macro project_card(project) %}
    <li class="project-card {% if project.staleness_level != 'ok' %}staleness-{{ project.staleness_level }}{% endif %}">
        <div class="project-header">
            <div class="project-info">
                <div class="client-name">{{ project.client_name }}</div>
                <div class="project-name-row">
                    <span class="project-name">{{ project.project_name }}</span>
                    {% if project.staleness_level != 'ok' %}
                    <span class="staleness-badge staleness-{{ project.staleness_level }}">
                        {{ project.days_since_update }}d stale
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="project-priority">
                <span class="priority priority-{{ project.priority }}">{{ project.priority }}</span>
            </div>
        </div>

        {# Latest status preview #}
        {% set preview = project.get_status_preview(3) %}
        {% if preview %}
        <div class="status-preview">
            <p class="preview-text">{{ preview.text }}</p>
            {% if preview.has_more %}
            <button type="button" class="btn-expand" data-full-text="{{ preview.full_text | e }}">
                Show more...
            </button>
            {% endif %}
        </div>
        {% endif %}

        {# Inline tasks #}
        {% set pending_tasks = project.get_pending_tasks() %}
        {% if pending_tasks %}
        <div class="inline-tasks">
            <span class="tasks-label">Tasks:</span>
            <ul class="task-inline-list">
                {% for task in pending_tasks %}
                <li class="task-inline {% if task.due_date < today %}task-overdue{% elif task.due_date == today %}task-due-today{% endif %}">
                    <div class="task-main">
                        <span class="task-target">{{ task.target_name }}</span>
                        <span class="task-type">({{ task.target_type | replace('_', ' ') | title }})</span>
                        <span class="task-due">({{ task.due_date.strftime('%b %d') }})</span>
                        <span class="task-priority priority-{{ task.priority }}">{{ task.priority[0] | upper }}</span>
                        <form action="{{ url_for('tasks.complete', id=task.id) }}" method="post" class="inline-form" data-confirm="Mark this task as complete?">
                            <button type="submit" class="btn btn-small btn-success">Done</button>
                        </form>
                        <form action="{{ url_for('tasks.snooze', id=task.id) }}" method="post" class="inline-form">
                            <input type="number" name="days" value="1" min="1" max="365" class="snooze-input">
                            <button type="submit" class="btn btn-small">Snooze</button>
                        </form>
                    </div>
                    {% if task.description %}
                    <div class="task-description">{{ task.description }}</div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {# Upcoming milestones #}
        {% set pending_milestones = project.get_pending_milestones() %}
        {% if pending_milestones %}
        <div class="inline-milestones">
            <span class="milestones-label">Milestones:</span>
            <ul class="milestone-inline-list">
                {% for milestone in pending_milestones[:3] %}
                <li class="milestone-inline {% if milestone.date < today %}milestone-overdue{% elif milestone.date == today %}milestone-due-today{% endif %}">
                    <span class="milestone-name">{{ milestone.name }}</span>
                    <span class="milestone-date">({{ milestone.date.strftime('%b %d') }})</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="project-actions">
            <a href="{{ url_for('updates.new') }}?project_id={{ project.id }}" class="btn btn-small btn-primary">Add Update</a>
            <a href="{{ url_for('tasks.new') }}?project_id={{ project.id }}" class="btn btn-small">Add Task</a>
            <a href="{{ url_for('projects.detail', id=project.id) }}" class="btn btn-small">View</a>
        </div>
    </li>
    {% endmacro %}

    {# Due Today/Overdue Section #}
    <section class="dashboard-section urgency-critical">
        <h2>Tasks Due Today / Overdue</h2>
        {% if due_today %}
        <ul class="dashboard-list project-list">
            {% for project in due_today %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="placeholder">No projects with tasks due today.</p>
        {% endif %}
    </section>

    {# Due Tomorrow Section #}
    <section class="dashboard-section urgency-warning">
        <h2>Tasks Due Tomorrow</h2>
        {% if due_tomorrow %}
        <ul class="dashboard-list project-list">
            {% for project in due_tomorrow %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="placeholder">No projects with tasks due tomorrow.</p>
        {% endif %}
    </section>

    {# Due This Week Section #}
    <section class="dashboard-section urgency-info">
        <h2>Tasks Due This Week</h2>
        {% if due_this_week %}
        <ul class="dashboard-list project-list">
            {% for project in due_this_week %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="placeholder">No projects with tasks due this week.</p>
        {% endif %}
    </section>

    {# Due Later Section #}
    <section class="dashboard-section">
        <h2>Tasks Due Later</h2>
        {% if due_later %}
        <ul class="dashboard-list project-list">
            {% for project in due_later %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="placeholder">No projects with tasks due in the next 2 weeks.</p>
        {% endif %}
    </section>

    {# No Tasks Section #}
    {% if no_tasks %}
    <section class="dashboard-section">
        <h2>Projects Without Tasks</h2>
        <ul class="dashboard-list project-list">
            {% for project in no_tasks %}
            {{ project_card(project) }}
            {% endfor %}
        </ul>
    </section>
    {% endif %}
</div>
{% endblock %}
