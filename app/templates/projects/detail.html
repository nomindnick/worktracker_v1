{% extends "base.html" %}

{% block title %}{{ project.client_name }}: {{ project.project_name }} - Legal Worklist{% endblock %}

{% block content %}
<div class="project-detail">
    <div class="page-header">
        <h1>{{ project.client_name }}: {{ project.project_name }}</h1>
        <div class="actions">
            <a href="{{ url_for('projects.edit', id=project.id) }}" class="btn">Edit</a>
            {% if project.status == 'active' %}
            <a href="{{ url_for('projects.archive', id=project.id) }}" class="btn btn-danger">Archive</a>
            {% else %}
            <form action="{{ url_for('projects.unarchive', id=project.id) }}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-success">Unarchive</button>
            </form>
            {% endif %}
        </div>
    </div>

    <section class="project-info">
        <h2>Project Information</h2>
        <dl class="info-grid">
            <dt>Client Number</dt>
            <dd>{{ project.client_number or '-' }}</dd>

            <dt>Matter Number</dt>
            <dd>{{ project.matter_number or '-' }}</dd>

            <dt>Assigner</dt>
            <dd>{{ project.assigner }}</dd>

            <dt>Assigned Attorneys</dt>
            <dd>{{ project.assigned_attorneys }}</dd>

            <dt>Priority</dt>
            <dd><span class="priority priority-{{ project.priority }}">{{ project.priority }}</span></dd>

            <dt>Estimated Hours</dt>
            <dd>{{ project.estimated_hours or '-' }}</dd>

            <dt>Actual Hours</dt>
            <dd>{{ project.actual_hours or '-' }}</dd>
        </dl>
    </section>

    <section class="milestones">
        <div class="section-header">
            <h2>Milestones</h2>
            <a href="{{ url_for('milestones.new') }}?project_id={{ project.id }}" class="btn btn-small">Add Milestone</a>
        </div>

        <h3>Upcoming</h3>
        {% set pending_milestones = project.get_pending_milestones() %}
        {% if pending_milestones %}
        <ul class="milestone-list">
            {% for milestone in pending_milestones %}
            <li class="milestone-item">
                <div class="milestone-info">
                    <span class="milestone-name">{{ milestone.name }}</span>
                    <span class="milestone-date">{{ milestone.date }}</span>
                    {% if milestone.description %}
                    <p class="milestone-description">{{ milestone.description }}</p>
                    {% endif %}
                </div>
                <div class="milestone-actions">
                    <form action="{{ url_for('milestones.complete', id=milestone.id) }}" method="post" style="display: inline;" data-confirm="Mark this milestone as complete?">
                        <button type="submit" class="btn btn-small btn-success">Complete</button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No upcoming milestones.</p>
        {% endif %}

        <h3>Completed</h3>
        {% set completed_milestones = project.get_completed_milestones() %}
        {% if completed_milestones %}
        <ul class="milestone-list">
            {% for milestone in completed_milestones %}
            <li class="milestone-item milestone-completed">
                <div class="milestone-info">
                    <span class="milestone-name">{{ milestone.name }}</span>
                    <span class="milestone-date">{{ milestone.date }}</span>
                    {% if milestone.description %}
                    <p class="milestone-description">{{ milestone.description }}</p>
                    {% endif %}
                </div>
                <div class="milestone-actions">
                    <form action="{{ url_for('milestones.uncomplete', id=milestone.id) }}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-small">Undo</button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No completed milestones.</p>
        {% endif %}
    </section>

    <section class="status-updates">
        <div class="section-header">
            <h2>Status Updates</h2>
            <a href="{{ url_for('updates.new') }}?project_id={{ project.id }}" class="btn btn-small">Add Update</a>
        </div>
        {% set updates = project.get_status_updates_ordered() %}
        {% if updates %}
        <ul class="update-list">
            {% for update in updates %}
            <li class="update-item">
                <span class="update-date">{{ update.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                <p class="update-notes">{{ update.notes }}</p>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No status updates yet.</p>
        {% endif %}
    </section>

    <section class="tasks">
        <div class="section-header">
            <h2>Tasks</h2>
            <a href="{{ url_for('tasks.new') }}?project_id={{ project.id }}" class="btn btn-small">Add Task</a>
        </div>

        <h3>Pending</h3>
        {% set pending = project.get_pending_tasks() %}
        {% if pending %}
        <ul class="task-list">
            {% for task in pending %}
            <li class="task-item">
                <div class="task-info">
                    <span class="task-target">{{ task.target_name }}</span>
                    <span class="task-type">({{ task.target_type | replace('_', ' ') | title }})</span>
                    <span class="task-due">Due: {{ task.due_date }}</span>
                    <span class="priority priority-{{ task.priority }}">{{ task.priority }}</span>
                    {% if task.description %}
                    <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                </div>
                <div class="task-actions">
                    <form action="{{ url_for('tasks.complete', id=task.id) }}" method="post" style="display: inline;" data-confirm="Mark this task as complete?">
                        <button type="submit" class="btn btn-small btn-success">Complete</button>
                    </form>
                    <form action="{{ url_for('tasks.snooze', id=task.id) }}" method="post" style="display: inline;">
                        <input type="number" name="days" value="1" min="1" max="365" style="width: 50px;">
                        <button type="submit" class="btn btn-small">Snooze</button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No pending tasks.</p>
        {% endif %}

        <h3>Completed</h3>
        {% set completed = project.get_completed_tasks() %}
        {% if completed %}
        <ul class="task-list">
            {% for task in completed %}
            <li class="task-item task-completed">
                <div class="task-info">
                    <span class="task-target">{{ task.target_name }}</span>
                    <span class="task-type">({{ task.target_type | replace('_', ' ') | title }})</span>
                    <span class="task-completed-at">Completed: {{ task.completed_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    {% if task.description %}
                    <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No completed tasks.</p>
        {% endif %}
    </section>
</div>
{% endblock %}
