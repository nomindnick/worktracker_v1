{% extends "base.html" %}

{% block title %}Projects - Legal Worklist{% endblock %}

{% block content %}
<div class="projects-list">
    <div class="page-header">
        <h1>Projects</h1>
        <a href="{{ url_for('projects.new') }}" class="btn btn-primary">New Project</a>
    </div>

    {# Filter Form #}
    <form class="filter-form" method="get" action="{{ url_for('projects.list') }}">
        <div class="filter-group">
            <label for="priority">Priority</label>
            <select name="priority" id="priority">
                <option value="">All</option>
                <option value="high" {{ 'selected' if current_filters.priority == 'high' }}>High</option>
                <option value="medium" {{ 'selected' if current_filters.priority == 'medium' }}>Medium</option>
                <option value="low" {{ 'selected' if current_filters.priority == 'low' }}>Low</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="attorney">Attorney</label>
            <select name="attorney" id="attorney">
                <option value="">All</option>
                {% for atty in attorneys %}
                <option value="{{ atty }}" {{ 'selected' if current_filters.attorney == atty }}>{{ atty }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="assigner">Assigner</label>
            <select name="assigner" id="assigner">
                <option value="">All</option>
                {% for asgn in assigners %}
                <option value="{{ asgn }}" {{ 'selected' if current_filters.assigner == asgn }}>{{ asgn }}</option>
                {% endfor %}
            </select>
        </div>
        {# Preserve sort state #}
        <input type="hidden" name="sort_by" value="{{ current_filters.sort_by }}">
        <input type="hidden" name="sort_order" value="{{ current_filters.sort_order }}">
        <div class="filter-actions">
            <button type="submit" class="btn btn-small">Apply Filters</button>
            <a href="{{ url_for('projects.list') }}" class="btn btn-small">Clear</a>
        </div>
    </form>

    {% if projects %}
    <div class="table-wrapper">
    <table class="data-table">
        <thead>
            <tr>
                <th>
                    {% set new_order = 'desc' if current_filters.sort_by == 'client_name' and current_filters.sort_order == 'asc' else 'asc' %}
                    <a href="{{ url_for('projects.list', priority=current_filters.priority, attorney=current_filters.attorney, assigner=current_filters.assigner, sort_by='client_name', sort_order=new_order) }}" class="sort-link">
                        Client
                        {% if current_filters.sort_by == 'client_name' %}
                        <span class="sort-indicator">{{ '▲' if current_filters.sort_order == 'asc' else '▼' }}</span>
                        {% endif %}
                    </a>
                </th>
                <th>Project</th>
                <th>Matter #</th>
                <th>Attorneys</th>
                <th>
                    {% set new_order = 'desc' if current_filters.sort_by == 'priority' and current_filters.sort_order == 'asc' else 'asc' %}
                    <a href="{{ url_for('projects.list', priority=current_filters.priority, attorney=current_filters.attorney, assigner=current_filters.assigner, sort_by='priority', sort_order=new_order) }}" class="sort-link">
                        Priority
                        {% if current_filters.sort_by == 'priority' %}
                        <span class="sort-indicator">{{ '▲' if current_filters.sort_order == 'asc' else '▼' }}</span>
                        {% endif %}
                    </a>
                </th>
                <th>Tasks</th>
                <th>Next Task</th>
                <th>Last Updated</th>
                <th>
                    {% set new_order = 'desc' if current_filters.sort_by == 'staleness' and current_filters.sort_order == 'asc' else 'asc' %}
                    <a href="{{ url_for('projects.list', priority=current_filters.priority, attorney=current_filters.attorney, assigner=current_filters.assigner, sort_by='staleness', sort_order=new_order) }}" class="sort-link">
                        Days Stale
                        {% if current_filters.sort_by == 'staleness' %}
                        <span class="sort-indicator">{{ '▲' if current_filters.sort_order == 'asc' else '▼' }}</span>
                        {% endif %}
                    </a>
                </th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
            <tr>
                <td>{{ project.client_name }}</td>
                <td><a href="{{ url_for('projects.detail', id=project.id) }}">{{ project.project_name }}</a></td>
                <td>{{ project.matter_number or '-' }}</td>
                <td>{{ project.assigned_attorneys }}</td>
                <td><span class="priority priority-{{ project.priority }}">{{ project.priority }}</span></td>
                <td>{{ project.pending_task_count }}</td>
                <td>{{ project.next_task.due_date if project.next_task else '-' }}</td>
                <td>{{ project.last_update_date.strftime('%Y-%m-%d') if project.last_update_date else '-' }}</td>
                <td><span class="staleness staleness-{{ project.staleness_level }}">{{ project.days_since_update }}d</span></td>
                <td>
                    <a href="{{ url_for('updates.new') }}?project_id={{ project.id }}" class="btn btn-small">Add Update</a>
                    <a href="{{ url_for('tasks.new') }}?project_id={{ project.id }}" class="btn btn-small">Add Task</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% else %}
    <p class="empty-state">No active projects. <a href="{{ url_for('projects.new') }}">Create your first project</a>.</p>
    {% endif %}
</div>
{% endblock %}
